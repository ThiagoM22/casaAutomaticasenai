import { useState, useEffect, useRef } from "react";
import { sendCommand, subscribeToDeviceStatus } from "../utils/esp32Service";

function Garagem() {
  const [portaoSocial, setPortaoSocial] = useState("fechado");
  const [portaoBasculante, setPortaoBasculante] = useState("fechado");
  const [luzGaragem, setLuzGaragem] = useState("desligada");
  const [isExpanded, setIsExpanded] = useState(false);

  const callbacksRegistered = useRef(false);
  const timerPortaoSocial = useRef(null); // Timer para fechar port√£o social automaticamente

  // Subscrever APENAS uma vez quando componente monta
  useEffect(() => {
    if (callbacksRegistered.current) return;

    console.log("üîó Registrando callbacks da Garagem (√öNICA VEZ)...");

    // Callbacks que N√ÉO interferem com estado local
    const handlePortaoSocialStatus = (status) => {
      console.log(
        "üì® Status port√£o social via MQTT (IGNORADO - usando local):",
        status
      );
      // COMENTADO para n√£o interferir com controle local
      // setPortaoSocial(...)
    };

    const handlePortaoBasculanteStatus = (status) => {
      console.log(
        "üì® Status port√£o basculante via MQTT (IGNORADO - usando local):",
        status
      );
      // COMENTADO para n√£o interferir com controle local
      // setPortaoBasculante(...)
    };

    const handleLuzGaragemStatus = (status) => {
      console.log(
        "üì® Status luz garagem via MQTT (IGNORADO - usando local):",
        status
      );
      // COMENTADO para n√£o interferir com controle local
      // setLuzGaragem(...)
    };

    subscribeToDeviceStatus("garagem/portao_social", handlePortaoSocialStatus);
    subscribeToDeviceStatus(
      "garagem/portao_basculante",
      handlePortaoBasculanteStatus
    );
    subscribeToDeviceStatus("garagem/luz", handleLuzGaragemStatus);

    callbacksRegistered.current = true;
  }, []);

  // Fun√ß√£o para controlar luz automaticamente baseado nos port√µes (APENAS localmente)
  const controlarLuzAutomatica = (statusSocial, statusBasculante) => {
    // Se qualquer port√£o estiver aberto, ligar a luz
    if (statusSocial === "aberto" || statusBasculante === "aberto") {
      console.log("üí° Ligando luz automaticamente (port√£o aberto)");
      setLuzGaragem("ligada");
      // Enviar comando para ESP32 tamb√©m
      sendCommand("garagem/luz", "ligar").catch(console.error);
    }
    // Se ambos port√µes estiverem fechados, desligar a luz
    else if (statusSocial === "fechado" && statusBasculante === "fechado") {
      console.log("üí° Desligando luz automaticamente (port√µes fechados)");
      setLuzGaragem("desligada");
      // Enviar comando para ESP32 tamb√©m
      sendCommand("garagem/luz", "desligar").catch(console.error);
    }
  };

  // Fun√ß√£o para fechar port√£o social automaticamente ap√≥s 5 segundos
  const fecharPortaoSocialAutomatico = () => {
    console.log("‚è∞ Fechando port√£o social automaticamente ap√≥s 5 segundos...");

    // Atualizar status localmente
    setPortaoSocial("fechado");

    // Controlar luz automaticamente usando os estados atuais
    controlarLuzAutomatica("fechado", portaoBasculante);

    // Enviar comando para ESP32
    sendCommand("garagem/portao_social", "fechar").catch(console.error);

    console.log("‚úÖ Port√£o social fechado automaticamente");
  };

  const abrirPortaoSocial = async () => {
    try {
      console.log("üéØ Abrindo port√£o social...");

      // Limpar timer anterior se existir
      if (timerPortaoSocial.current) {
        clearTimeout(timerPortaoSocial.current);
        timerPortaoSocial.current = null;
      }

      // Atualizar status localmente imediatamente
      setPortaoSocial("aberto");

      // Controlar luz automaticamente usando os estados atuais
      controlarLuzAutomatica("aberto", portaoBasculante);

      await sendCommand("garagem/portao_social", "abrir");
      console.log("‚úÖ Port√£o social aberto com sucesso");

      // Configurar timer para fechar automaticamente ap√≥s 5 segundos
      timerPortaoSocial.current = setTimeout(() => {
        fecharPortaoSocialAutomatico();
        timerPortaoSocial.current = null;
      }, 5000);

      console.log("‚è≤Ô∏è Timer de 5 segundos iniciado para fechar port√£o social");
    } catch (error) {
      console.error("‚ùå Erro ao abrir port√£o social:", error);
      // Reverter em caso de erro
      setPortaoSocial("fechado");
      controlarLuzAutomatica("fechado", portaoBasculante);
    }
  };

  const fecharPortaoSocial = async () => {
    try {
      console.log("üéØ Fechando port√£o social manualmente...");

      // Limpar timer se existir (fechamento manual)
      if (timerPortaoSocial.current) {
        clearTimeout(timerPortaoSocial.current);
        timerPortaoSocial.current = null;
        console.log("‚èπÔ∏è Timer cancelado (fechamento manual)");
      }

      // Atualizar status localmente imediatamente
      setPortaoSocial("fechado");

      // Controlar luz automaticamente usando os estados atuais
      controlarLuzAutomatica("fechado", portaoBasculante);

      await sendCommand("garagem/portao_social", "fechar");
      console.log("‚úÖ Port√£o social fechado manualmente com sucesso");
    } catch (error) {
      console.error("‚ùå Erro ao fechar port√£o social:", error);
      // Reverter em caso de erro
      setPortaoSocial("aberto");
      controlarLuzAutomatica("aberto", portaoBasculante);
    }
  };

  const abrirPortaoBasculante = async () => {
    try {
      console.log("üéØ Abrindo port√£o basculante...");

      // Atualizar status localmente imediatamente
      setPortaoBasculante("aberto");

      // Controlar luz automaticamente usando os estados atuais
      controlarLuzAutomatica(portaoSocial, "aberto");

      await sendCommand("garagem/portao_basculante", "abrir");
      console.log("‚úÖ Port√£o basculante aberto com sucesso");
    } catch (error) {
      console.error("‚ùå Erro ao abrir port√£o basculante:", error);
      // Reverter em caso de erro
      setPortaoBasculante("fechado");
      controlarLuzAutomatica(portaoSocial, "fechado");
    }
  };

  const fecharPortaoBasculante = async () => {
    try {
      console.log("üéØ Fechando port√£o basculante...");

      // Atualizar status localmente imediatamente
      setPortaoBasculante("fechado");

      // Controlar luz automaticamente usando os estados atuais
      controlarLuzAutomatica(portaoSocial, "fechado");

      await sendCommand("garagem/portao_basculante", "fechar");
      console.log("‚úÖ Port√£o basculante fechado com sucesso");
    } catch (error) {
      console.error("‚ùå Erro ao fechar port√£o basculante:", error);
      // Reverter em caso de erro
      setPortaoBasculante("aberto");
      controlarLuzAutomatica(portaoSocial, "aberto");
    }
  };

  const ligarLuzGaragem = async () => {
    try {
      console.log("üéØ Ligando luz da garagem...");

      // Atualizar status localmente imediatamente
      setLuzGaragem("ligada");

      await sendCommand("garagem/luz", "ligar");
      console.log("‚úÖ Luz da garagem ligada com sucesso");
    } catch (error) {
      console.error("‚ùå Erro ao ligar luz da garagem:", error);
      // Reverter em caso de erro
      setLuzGaragem("desligada");
    }
  };

  const desligarLuzGaragem = async () => {
    try {
      console.log("üéØ Desligando luz da garagem...");

      // Atualizar status localmente imediatamente
      setLuzGaragem("desligada");

      await sendCommand("garagem/luz", "desligar");
      console.log("‚úÖ Luz da garagem desligada com sucesso");
    } catch (error) {
      console.error("‚ùå Erro ao desligar luz da garagem:", error);
      // Reverter em caso de erro
      setLuzGaragem("ligada");
    }
  };

  // Limpar timer quando componente for desmontado
  useEffect(() => {
    return () => {
      if (timerPortaoSocial.current) {
        clearTimeout(timerPortaoSocial.current);
      }
    };
  }, []);

  // Mobile toggle function
  const toggleMobileExpanded = () => {
    if (window.innerWidth <= 768) {
      setIsExpanded(!isExpanded);
    }
  };

  return (
    <div className="environment-card">
      <h2 
        className={isExpanded ? 'expanded' : ''} 
        onClick={toggleMobileExpanded}
      >
        üöó Garagem
      </h2>

      <div className={`environment-content ${isExpanded ? 'expanded' : ''}`}>
        <div className="controls">
          <div className="control-item">
            <h3>Port√£o Social</h3>
            <div className="button-group">
              <button
                className="btn btn-success"
                onClick={abrirPortaoSocial}
                disabled={portaoSocial === "aberto"}
              >
                üîí Abrir
              </button>
            </div>
            <span
              className={`status ${
                portaoSocial === "aberto" ? "status-active" : "status-inactive"
              }`}
            >
              Status: {portaoSocial}{" "}
              {portaoSocial === "aberto" ? "(5s auto-close)" : ""}
            </span>
          </div>

          <div className="control-item">
            <h3>Port√£o Basculante</h3>
            <div className="button-group">
              <button
                className="btn btn-success"
                onClick={abrirPortaoBasculante}
                disabled={portaoBasculante === "aberto"}
              >
                ‚¨ÜÔ∏è Abrir
              </button>
              <button
                className="btn btn-danger"
                onClick={fecharPortaoBasculante}
                disabled={portaoBasculante === "fechado"}
              >
                ‚¨áÔ∏è Fechar
              </button>
            </div>
            <span
              className={`status ${
                portaoBasculante === "aberto"
                  ? "status-active"
                  : "status-inactive"
              }`}
            >
              Status: {portaoBasculante}
            </span>
          </div>

          <div className="control-item">
            <h3>Luz da Garagem</h3>
            <div className="button-group">
              <button
                className="btn btn-warning"
                onClick={ligarLuzGaragem}
                disabled={luzGaragem === "ligada"}
              >
                üîÜ Ligar
              </button>
              <button
                className="btn btn-secondary"
                onClick={desligarLuzGaragem}
                disabled={luzGaragem === "desligada"}
              >
                üí° Desligar
              </button>
            </div>
            <span
              className={`status ${
                luzGaragem === "ligada" ? "status-active" : "status-inactive"
              }`}
            >
              Status: {luzGaragem}{" "}
              {portaoSocial === "aberto" || portaoBasculante === "aberto"
                ? "(Auto)"
                : ""}
            </span>
          </div>
        </div>
      </div>
    </div>
  );
}

export default Garagem;
